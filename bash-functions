# Bash functions for chcreds
#
# This file should be sourced from your ~/.bashrc file like:
#   . ~/projects/openstack-bash-creds-helper/bash-functions
#
# Andy Botting <andy@andybotting.com>

CHCRED_FILE="${CHCRED_FILE:-$HOME/.chcred}"

function creds() {
    if [ -f $CHCRED_FILE ]; then
        cred=$(cat $CHCRED_FILE)
        export OS_CRED=${cred%.openrc}
        . <(pass $cred)
    else
        chcreds
    fi
}

function chcreds() {
    if builtin type -P fzf &> /dev/null; then
        # Using fzf (if installed) for cred chooser
        rmcreds && openstack_creds "$1" && creds
    else
        # Regular choice list
        tput smcup && tput cup 0 0 && rmcreds && \
        openstack_creds "$1" && creds && tput rmcup
    fi
}

function rmcreds() {
    for v in $(env | grep -E '^OS_' | sed 's/=.*//'); do
      unset $v
    done
}

function prcreds {
    env | grep -E '^OS_'
}

# Function useful for adding to your bash prompt
function os_creds {
    [ -z $OS_CRED ] || echo " $OS_CRED"
}

# vim:syntax=sh
